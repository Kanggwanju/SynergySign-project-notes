# ì„¸ë¶€ì‚¬í•­ ë…¼ì˜


## í˜„ì¬ ì§„í–‰ ë¼ìš´ë“œ ì¶”ì 

ìš°ë¦¬ ì„œë¹„ìŠ¤ ì‹œë‚˜ë¦¬ì˜¤:
1ë¼ìš´ë“œ ì™„ë£Œ â†’ ëŒ€ê¸°ì‹¤ ë³µê·€ â†’ ì¤€ë¹„ â†’ 2ë¼ìš´ë“œ ì‹œì‘ â†’ ...

ë”°ë¡œ ë¼ìš´ë“œì— ëŒ€í•œ ì •ë³´ê°€ ì—†ìœ¼ë¯€ë¡œ game_history ì—”í‹°í‹°ì—ì„œ ì—­ìœ¼ë¡œ ì¶”ë¡ í•´ì•¼ í•¨.
-> ë³µì¡í•œ ê³¼ì •ì„ ê±°ì¹  ê²ƒìœ¼ë¡œ ì˜ˆìƒë¨.

ëŒ€ê¸°ì‹¤ ì…ì¥: ì´ê²Œ ì²« ëŒ€ê¸°ì‹¤ì¸ì§€, 1ë¼ìš´ë“œ í›„ ëŒ€ê¸°ì‹¤ì¸ì§€, 2ë¼ìš´ë“œ í›„ ëŒ€ê¸°ì‹¤ì¸ì§€ ëª¨ë¦„
GameRoom í´ë˜ìŠ¤ì— currentRound  í•„ë“œë¥¼ ì¶”ê°€í•˜ë©´ í•´ê²° ê°€ëŠ¥
```
@Column(nullable = false)
private Integer currentRound;  // í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ë¼ìš´ë“œ
```

---


## í€´ì¦ˆ ê²Œì„ ì§„í–‰ ê´€ë ¨

ë¬¸ì œ 1~7: ë©”ëª¨ë¦¬(Redis/HashMap)ì—ì„œ ì ìˆ˜ ê´€ë¦¬
â†“
ì‹¤ì‹œê°„ UI ì—…ë°ì´íŠ¸ (WebSocket)
â†“
ë¬¸ì œ 8 ì™„ë£Œ: ìµœì¢… ì ìˆ˜ë¥¼ DBì— ì €ì¥


---

## ì „ì²´ ê²Œì„ ë°© ëª©ë¡ ì¡°íšŒ ë°©ì‹

1. ë¬´í•œìŠ¤í¬ë¡¤
2. í˜ì´ì§€
3. í•œë²ˆì— ì–¼ë§ˆë‚˜ ê°€ì ¸ì˜¬ì§€
4. í•„í„°ë§ì€ ì–´ë–»ê²Œ í• ì§€

---

## í€´ì¦ˆ ê²Œì„ ëœë¤ ë‹¨ì–´ ì²˜ë¦¬ ë°©ì‹

ì›¹ì†Œì¼“
- í€´ì¦ˆ ì‹œì‘: `/app/rooms/{roomId}/start`
- ë¬¸ì œ ì¶œì œ: `/topic/rooms/{roomId}`

```text
1. í€´ì¦ˆ ì‹œì‘
   â†“
[ë©”ëª¨ë¦¬] roomId: 123 â†’ [word1, word2, ..., word8]
[ë©”ëª¨ë¦¬] currentIndex: 0

2. ì²« ë²ˆì§¸ ë¬¸ì œ ì¶œì œ
   â†“
ë©”ëª¨ë¦¬ì—ì„œ questions[0] ê°€ì ¸ì˜¤ê¸°
   â†“
WebSocket â†’ { wordId: 5, title: "ì‚¬ë‘í•´ìš”" }

3. ë‹µë³€ ì œì¶œ
   â†“
currentIndex++

4. ë‘ ë²ˆì§¸ ë¬¸ì œ ì¶œì œ
   â†“
ë©”ëª¨ë¦¬ì—ì„œ questions[1] ê°€ì ¸ì˜¤ê¸°
   â†“
WebSocket â†’ { wordId: 12, title: "ê³ ë§ˆì›Œìš”" }

...

9. 8ë²ˆì§¸ ë¬¸ì œ ë‹µë³€ ì™„ë£Œ
   â†“
ë¼ìš´ë“œ ì¢…ë£Œ
   â†“
ë©”ëª¨ë¦¬ ì •ë¦¬ (roomQuestions, currentIndex ì‚­ì œ)
```

---

## ì ìˆ˜ í‘œì‹œ ì‹œë‚˜ë¦¬ì˜¤

### ìœ ì €ì˜ "ì´ ì ìˆ˜"ë¥¼ ë³´ì—¬ì¤˜ì•¼ í•˜ëŠ” ì‹œì :

1. **ë°© ì…ì¥ ì‹œ** - ë‹¤ë¥¸ ì°¸ê°€ìë“¤ì˜ ì´ ì ìˆ˜ í™•ì¸
2. **ëŒ€ê¸°ì‹¤ì—ì„œ** - ì‹¤ì‹œê°„ìœ¼ë¡œ ëˆ„ê°€ ë“¤ì–´ì˜¤ëŠ”ì§€ + ê·¸ ì‚¬ëŒ ì´ ì ìˆ˜
3. **í”„ë¡œí•„ ì¡°íšŒ** - ë‚´ ì´ ì ìˆ˜ í™•ì¸

---

## ë‹µë³€: **HTTP, WebSocket ë‘˜ ë‹¤ í•„ìš”**

### 1. **HTTP (REST API)** - ì´ ì ìˆ˜ ì¡°íšŒ

#### ì‚¬ìš© ì‹œì :
- ë°© ì •ë³´ë¥¼ **ì²˜ìŒ ì¡°íšŒ**í•  ë•Œ
- í”„ë¡œí•„ í˜ì´ì§€ì—ì„œ **ë‚´ ì ìˆ˜** í™•ì¸

#### API ì˜ˆì‹œ:
```
// ë°© ìƒì„¸ ì¡°íšŒ ì‹œ ì°¸ê°€ì ì ìˆ˜ í¬í•¨
GET /api/quiz/rooms/{roomId}

// ì‘ë‹µ
{
  "participants": [
    {
      "userId": 1,
      "nickname": "í™ê¸¸ë™",
      "totalScore": 2450,  // ğŸ‘ˆ ê²Œì„ íˆìŠ¤í† ë¦¬ í•©ì‚°
      "isHost": true,
      "isReady": true
    },
    {
      "userId": 2,
      "nickname": "ê¹€ì˜í¬",
      "totalScore": 1820,  // ğŸ‘ˆ ê²Œì„ íˆìŠ¤í† ë¦¬ í•©ì‚°
      "isHost": false,
      "isReady": false
    }
  ]
}
```

---

### 2. **WebSocket** - ì‹¤ì‹œê°„ ì ìˆ˜ ë™ê¸°í™”

#### ì‚¬ìš© ì‹œì :
- **ìƒˆë¡œìš´ ìœ ì €ê°€ ì…ì¥**í•  ë•Œ â†’ ëª¨ë“  ì°¸ê°€ìì—ê²Œ ì•Œë¦¼
- ëŒ€ê¸°ì‹¤ì—ì„œ ì‹¤ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸

#### WebSocket ì´ë²¤íŠ¸:
```
// ìœ ì € ì…ì¥ ì‹œ
DESTINATION: /topic/rooms/{roomId}
{
  "type": "user_joined",
  "data": {
    "user": {
      "userId": 3,
      "nickname": "ë°•ë¯¼ìˆ˜",
      "totalScore": 980,  // ğŸ‘ˆ DBì—ì„œ ê³„ì‚°í•´ì„œ í¬í•¨
      "isHost": false,
      "isReady": false
    },
    "room": {
      "participants": [
        {
          "userId": 1,
          "nickname": "í™ê¸¸ë™",
          "totalScore": 2450
        },
        {
          "userId": 2,
          "nickname": "ê¹€ì˜í¬",
          "totalScore": 1820
        },
        {
          "userId": 3,
          "nickname": "ë°•ë¯¼ìˆ˜",
          "totalScore": 980
        }
      ]
    }
  }
}
```

---

## ğŸš€ ì„±ëŠ¥ ìµœì í™” (ì„ íƒì‚¬í•­)

### ë¬¸ì œ:
- ë§¤ë²ˆ `SUM(score)` ê³„ì‚°í•˜ë©´ **ëŠë¦¼**

### í•´ê²°ì±… 1: **User ì—”í‹°í‹°ì— totalScore í•„ë“œ ì¶”ê°€**

```java
@Entity
public class User {
    
    @Id
    private Long id;
    
    private String nickname;
    
    // ğŸ‘‡ ì´ ì ìˆ˜ ìºì‹œ
    @Column(nullable = false)
    private Integer totalScore = 0;
    
    // ì ìˆ˜ ì—…ë°ì´íŠ¸
    public void addScore(int score) {
        this.totalScore += score;
    }
}
```

```java
// ë¼ìš´ë“œ ì¢…ë£Œ ì‹œ ì ìˆ˜ ì—…ë°ì´íŠ¸
@Service
public class QuizService {
    
    public void endRound(Long roomId) {
        Map<Long, Integer> finalScores = scoreManager.getRoundScores(roomId);
        
        finalScores.forEach((userId, score) -> {
            User user = userRepository.findById(userId).orElseThrow();
            
            // 1. íˆìŠ¤í† ë¦¬ ì €ì¥
            gameHistoryRepository.save(GameHistory.builder()
                .participant(user)
                .score(score)
                .build());
            
            // 2. ìœ ì € ì´ ì ìˆ˜ ì—…ë°ì´íŠ¸ ğŸ‘ˆ
            user.addScore(score);
            userRepository.save(user);
        });
    }
}
```

**ì¥ì :**
- âœ… ë§¤ë²ˆ SUM ê³„ì‚° ë¶ˆí•„ìš”
- âœ… ë¹ ë¥¸ ì¡°íšŒ (`user.getTotalScore()`)

**ë‹¨ì :**
- âŒ ë°ì´í„° ì¤‘ë³µ (ì •ê·œí™” ìœ„ë°˜)
- âŒ ë™ê¸°í™” ê´€ë¦¬ í•„ìš”

---

### í•´ê²°ì±… 2: **Redis ìºì‹±**

```java
@Service
public class UserService {
    
    @Autowired
    private RedisTemplate<String, Integer> redisTemplate;
    
    public int calculateTotalScore(Long userId) {
        String cacheKey = "user:totalScore:" + userId;
        
        // 1. ìºì‹œ í™•ì¸
        Integer cached = redisTemplate.opsForValue().get(cacheKey);
        if (cached != null) {
            return cached;
        }
        
        // 2. DB ê³„ì‚°
        Integer totalScore = gameHistoryRepository.sumScoreByUserId(userId);
        int score = totalScore != null ? totalScore : 0;
        
        // 3. ìºì‹œ ì €ì¥ (1ì‹œê°„)
        redisTemplate.opsForValue().set(cacheKey, score, 1, TimeUnit.HOURS);
        
        return score;
    }
    
    // ì ìˆ˜ ì—…ë°ì´íŠ¸ ì‹œ ìºì‹œ ë¬´íš¨í™”
    public void invalidateTotalScoreCache(Long userId) {
        String cacheKey = "user:totalScore:" + userId;
        redisTemplate.delete(cacheKey);
    }
}
```

---

## ğŸ“‹ ì •ë¦¬

### **HTTP vs WebSocket**

| ìƒí™© | ì‚¬ìš© ë°©ë²• | ì´ìœ  |
|-----|---------|------|
| ë°© ìƒì„¸ ì¡°íšŒ | **HTTP** | í˜ì´ì§€ ë¡œë“œ ì‹œ í•œ ë²ˆë§Œ |
| í”„ë¡œí•„ ì¡°íšŒ | **HTTP** | ë‚´ ì ìˆ˜ í™•ì¸ |
| ìœ ì € ì…ì¥ ì•Œë¦¼ | **WebSocket** | ì‹¤ì‹œê°„ ë™ê¸°í™” |
| ëŒ€ê¸°ì‹¤ ì—…ë°ì´íŠ¸ | **WebSocket** | ì‹¤ì‹œê°„ ë™ê¸°í™” |

### **MVP ë‹¨ê³„ ì¶”ì²œ**
1. **SQL SUMìœ¼ë¡œ ê³„ì‚°** (ê°„ë‹¨)
2. ë‚˜ì¤‘ì— **User.totalScore í•„ë“œ ì¶”ê°€** (ì„±ëŠ¥ ê°œì„ )
3. íŠ¸ë˜í”½ ë§ì•„ì§€ë©´ **Redis ìºì‹±** (í™•ì¥ì„±)

