## π“΅ WebSocket μ—°κ²° λ° λ©”μ‹μ§€ μ²λ¦¬ νλ¦„

### **1λ‹¨κ³„: μ΄κΈ° μ„¤μ • (WebSocketConfig)**

ν΄λΌμ΄μ–ΈνΈκ°€ WebSocket μ—°κ²°μ„ μ‹λ„ν•λ©΄:

```
ν΄λΌμ΄μ–ΈνΈ β†’ http://localhost:5173 μ—μ„ /ws μ—”λ“ν¬μΈνΈλ΅ μ—°κ²° μ‹λ„
```

- **μ—”λ“ν¬μΈνΈ**: `/ws`λ΅ STOMP μ—°κ²° μ„¤μ •
- **λ©”μ‹μ§€ λΈλ΅μ»¤**: `/topic`, `/queue`λ΅ μ‹μ‘ν•λ” κµ¬λ… κ²½λ΅ ν™μ„±ν™”
- **μ• ν”λ¦¬μΌ€μ΄μ… λ©μ μ§€**: `/app`μΌλ΅ μ‹μ‘ν•λ” λ©”μ‹μ§€ μ „μ†΅ κ²½λ΅
- **ν•Έλ“μ…°μ΄ν¬ μΈν„°μ…‰ν„°**: `CookieAuthHandshakeInterceptor`κ°€ μΏ ν‚¤ κΈ°λ° μΈμ¦ μ²λ¦¬

---

### **2λ‹¨κ³„: CONNECT - μ—°κ²° μλ¦½**

ν΄λΌμ΄μ–ΈνΈκ°€ STOMP CONNECT ν”„λ μ„μ„ λ³΄λ‚΄λ©΄:

#### **λ³΄μ• κ²€μ¦ (WebSocketSecurityConfig)**
- μΈμ¦λ μ‚¬μ©μμΈμ§€ ν™•μΈ
- μΈμ¦λμ§€ μ•μ€ μ”μ²­μ€ μ¦‰μ‹ κ±°λ¶€

#### **λ‹¨μΌ μ„Έμ… μ •μ±… μ μ© (SingleSessionChannelInterceptor)**
```
handleConnect(accessor) μ‹¤ν–‰:
1. μΈμ¦ μ •λ³΄ ν™•μΈ (accessor.getUser())
2. userIdμ™€ sessionId μ¶”μ¶
3. hasOtherActiveSession() ν™•μΈ
   - λ‹¤λ¥Έ ν™μ„± μ„Έμ…μ΄ μμΌλ©΄ β†’ MessagingException λ°μƒ (μ¤‘λ³µ μ ‘μ† μ°¨λ‹¨)
   - μ—†μΌλ©΄ β†’ userSessionRegistry.bind(userId, sessionId) μ‹¤ν–‰
```

**κ²°κ³Ό**: μ‚¬μ©μλ‹Ή ν•λ‚μ ν™μ„± WebSocket μ„Έμ…λ§ μ μ§€ (λ‹¨μΌ νƒ­ κ°•μ )

---

### **3λ‹¨κ³„: SUBSCRIBE - κµ¬λ… μ”μ²­**

ν΄λΌμ΄μ–ΈνΈκ°€ `/topic/room/{roomId}/participant` κ°™μ€ κ²½λ΅λ¥Ό κµ¬λ…ν•λ©΄:

#### **λ³΄μ• κ²€μ¦**
- `/topic/**`, `/queue/**` κµ¬λ…μ€ μΈμ¦ ν•„μ”
- μΈμ¦λμ§€ μ•μ€ κµ¬λ…μ€ κ±°λ¶€

#### **ν™μ„± μ„Έμ… κ²€μ¦ (SingleSessionChannelInterceptor)**
```
handleSubscribe(accessor) μ‹¤ν–‰:
1. userIdμ™€ sessionId μ¶”μ¶
2. isActive(userId, sessionId) ν™•μΈ
   - ν„μ¬ λ“±λ΅λ ν™μ„± μ„Έμ…μ΄ μ•„λ‹λ©΄ β†’ μ°¨λ‹¨
   - ν™μ„± μ„Έμ…μ΄λ©΄ β†’ κµ¬λ… ν—μ©
```

**λ©μ **: μ¤λλ νƒ­μ΄λ‚ λΉ„ν™μ„± μ„Έμ…μ—μ„μ κµ¬λ… μ”μ²­μ„ μ°¨λ‹¨

---

### **4λ‹¨κ³„: SEND - λ©”μ‹μ§€ μ „μ†΅**

ν΄λΌμ΄μ–ΈνΈκ°€ `/app/**` κ²½λ΅λ΅ λ©”μ‹μ§€λ¥Ό λ³΄λ‚΄λ©΄:

#### **λ³΄μ• κ²€μ¦**
- `/app/**` μ „μ†΅μ€ μΈμ¦ ν•„μ”

#### **μΈν„°μ…‰ν„° ν†µκ³Ό**
- `SingleSessionChannelInterceptor`λ” SEND λ…λ Ήμ— λ€ν•΄μ„λ” νΉλ³„ν• κ²€μ¦ μ—†μ΄ ν†µκ³Ό
- μ• ν”λ¦¬μΌ€μ΄μ… λ΅μ§μ΄ λ©”μ‹μ§€ μ²λ¦¬

---

### **5λ‹¨κ³„: DISCONNECT - μ—°κ²° μΆ…λ£**

ν΄λΌμ΄μ–ΈνΈ μ—°κ²°μ΄ λκΈ°λ©΄:

#### **μΈν„°μ…‰ν„°μ—μ„ λ΅κΉ… (SingleSessionChannelInterceptor)**
```
handleDisconnect(accessor):
- λ΅κ·Έλ§ κΈ°λ΅
- μ‹¤μ  μ–Έλ°”μΈλ“λ” ν•μ§€ μ•μ (μ΄λ²¤νΈ λ¦¬μ¤λ„μ—μ„ μ²λ¦¬)
```

#### **μ΄λ²¤νΈ λ¦¬μ¤λ„ μ²λ¦¬ (WebSocketEventsListener)**
```
onDisconnect(event) μ‹¤ν–‰:
1. userIdμ™€ sessionId μ¶”μ¶
2. isActive() ν™•μΈ
   - λΉ„ν™μ„± μ„Έμ…μ΄λ©΄ β†’ λ¬΄μ‹ (μ¤ν…μΌ μ„Έμ…)
   - ν™μ„± μ„Έμ…μ΄λ©΄ β†’ κ³„μ† μ§„ν–‰
3. leaveCurrentRoomByUser(userId) νΈμ¶
   - μ°Έμ—¬ μ¤‘μΈ κ²μ„λ°©μ—μ„ μλ™ ν‡΄μ¥ μ²λ¦¬
4. λ°©μ λ‹¤λ¥Έ μ°Έμ—¬μλ“¤μ—κ² μ•λ¦Ό μ „μ†΅
5. finally λΈ”λ΅μ—μ„ unbind(userId, sessionId)
   - μμ™Έ λ°μƒ μ—¬λ¶€μ™€ κ΄€κ³„μ—†μ΄ μ„Έμ… λ§¤ν•‘ μ •λ¦¬
```

---

## π”’ ν•µμ‹¬ μ„¤κ³„ ν¬μΈνΈ

### **λ‹¨μΌ νƒ­ κ°•μ  μ •μ±…**
```
UserSessionRegistryμ—μ„ userId β†’ sessionId λ§¤ν•‘ κ΄€λ¦¬
- μƒ νƒ­ μ—΄κΈ° β†’ μ΄μ „ μ„Έμ…μ΄ μμΌλ©΄ CONNECT μ°¨λ‹¨
- λΈλΌμ°μ € μƒλ΅κ³ μΉ¨ β†’ μƒ sessionIdλ΅ κΈ°μ΅΄ λ§¤ν•‘ λ®μ–΄μ“°κΈ°
```

### **μ¤ν…μΌ μ„Έμ… λ°©μ§€**
```
λ°”μΈλ”©: μΈν„°μ…‰ν„° (CONNECT μ‹μ )
κ²€μ¦: μΈν„°μ…‰ν„° (SUBSCRIBE μ‹μ )
μ •λ¦¬: μ΄λ²¤νΈ λ¦¬μ¤λ„ (finally λΈ”λ΅)
```

μ΄λ ‡κ² λ¶„λ¦¬ν•μ—¬ λ„¤νΈμ›ν¬ μ§€μ—°μ΄λ‚ μμ™Έ μƒν™©μ—μ„λ„ μ¤λλ λ§¤ν•‘μ΄ λ‚¨μ§€ μ•λ„λ΅ λ³΄μ¥ν•©λ‹λ‹¤.

### **λ©”μ‹μ§€ νλ¦„ μ”μ•½**
```
ν΄λΌμ΄μ–ΈνΈ β†’ /ws (ν•Έλ“μ…°μ΄ν¬) 
β†’ CONNECT (λ³΄μ• + λ‹¨μΌμ„Έμ… κ²€μ¦ + λ°”μΈλ”©)
β†’ SUBSCRIBE (λ³΄μ• + ν™μ„±μ„Έμ… κ²€μ¦)
β†’ SEND/RECEIVE (λ³΄μ• κ²€μ¦)
β†’ DISCONNECT (μ΄λ²¤νΈ λ¦¬μ¤λ„μ—μ„ μ •λ¦¬ + μ–Έλ°”μΈλ”©)
```

μ΄ κµ¬μ΅°λ¥Ό ν†µν•΄ μ•μ „ν•κ³  μΌκ΄€λ WebSocket ν†µμ‹  ν™κ²½μ„ μ κ³µν•©λ‹λ‹¤!